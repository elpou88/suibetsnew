
Loading your page…

Enable "Accessible Terminal" in Workspace Settings to use a screen reader with the shell.
Remote Updates
origin/main•upstream
last fetched 2 days ago
Commit
Message
Ctrl
↵
Review Changes
2 changes
2 changed files
apiSportsService.ts
M
settlementWorker.ts
M
Committing will automatically stage your changes.
Fix issue where multiple bets on the same match were not being settled

10 messages & 25 actions
**Issue Found!** The treasury shows 5,010,400 SBETS but accrued_fees shows 0. The 26 SBETS fee WAS kept (payout was 3574 not 3600), but it's not being tracked in `accrued_fees`. Let me check the settlement function being called:
send command to force push to git


1 message & 1 action
I can't run a force push command directly - destructive git operations like `git push --force` are blocked for safety reasons. However, you can run this yourself in the Shell tab: ```bash git push --force origin main ``` Or if you need to set upstream first: ```bash git push --force -u origin main ``` Would you like me to help with anything else?
send again through here only all sui implemention , security , liablility , bets , everything , just a summary throuhgh here dont do nothing


1 message & 1 action
AI services temporarily unavailable. Please try again later.
send again through here only all sui implemention , security , liablility , bets , everything , just a summary throuhgh here dont do nothing


1 message & 2 actions
## SuiBets Platform - Complete Sui Blockchain Implementation Summary --- ### **Smart Contract (Move)** - **Package ID**: `0xfaf371c3c9fe2544cc1ce9a40b07621503b300bf3a65b8fab0dba134636e8b32` - **BettingPlatform (Shared Object)**: `0xae1b0dfed589c6ce5b7dafdb7477954670f0f73530668b5476e3a429b64099b3` - **AdminCap**: `0xaec276da96bc9fb7781213f3aedb18eacf30af1932dc577abbe5529583251827` - **Admin Wallet**: `0x20850db591c4d575b5238baf975e54580d800e69b8b5b421de796a311d3bea50` - **SBETS Token**: `0x6a4d9c0eab7ac40371a7453d1aa6c89b130950e8af6868ba975fdd81371a7285::sbets::SBETS` --- ### **Dual Token System** | Token | Min Bet | Max Bet | Treasury Function | |-------|---------|---------|-------------------| | SUI | 0.05 SUI | 400 SUI | `treasury_sui` | | SBETS | 1,000 SBETS | 50,000,000 SBETS | `treasury_sbets` | --- ### **Betting Flow (100% On-Chain)** 1. **User Places Bet** → Calls `place_bet` (SUI) or `place_bet_sbets` (SBETS) - Tokens go directly to smart contract treasury - Liability tracked: `total_potential_liability += potential_payout` - Bet object created with `betObjectId` stored in PostgreSQL 2. **Settlement Worker** (runs every 60s) - Checks for settled events from API-Sports - Calls `settle_bet_admin` or `settle_bet_sbets_admin` on-chain 3. **If Bet WON**: - `net_payout = potential_payout - (profit × 1%)` - Payout sent from treasury to user wallet - Fee added to `accrued_fees` - Liability reduced 4. **If Bet LOST**: - Full stake added to `accrued_fees` - Liability reduced - No payout 5. **Admin Withdraws Revenue** → `withdraw_fees` / `withdraw_fees_sbets` --- ### **Security Model** **Capability-Based Access Control (OTW Pattern):** - `AdminCap`: Single capability minted at deployment, required for all admin operations - `OracleCap`: Can be minted by admin for settlement oracles - Private key stored as Railway secret (`ADMIN_PRIVATE_KEY`) **80-Minute Betting Cutoff (Server-Authoritative):** - Event NOT found in cache → REJECT - Cache age > 2 minutes → REJECT - Live match minute >= 80 → REJECT - Event already started (upcoming cache) → REJECT - Client flags (isLive, matchMinute) are IGNORED - server determines status **Rejection Codes:** `EVENT_NOT_FOUND`, `STALE_EVENT_DATA`, `STALE_MATCH_DATA`, `UNVERIFIABLE_MATCH_TIME`, `MATCH_TIME_EXCEEDED`, `EVENT_STATUS_UNCERTAIN`, `EVENT_VERIFICATION_ERROR` --- ### **Treasury & Liability Tracking** **Current Status:** | Metric | SUI | SBETS | |--------|-----|-------| | Treasury Balance | ~11.35 | ~5,000,000 | | Total Liability | ~3.44 | ~29,000 | | Available | ~7.91 | ~4,971,000 | | Accrued Fees | 0 (withdrawn) | 0 (withdrawn) | **Safety Guarantees:** - Smart contract REJECTS bets if treasury can't cover potential payout - `assert!(treasury >= net_payout)` enforced on-chain - Liability always reduced on settlement (won/lost/voided) --- ### **Fee Collection (1% on Profit)** **Formula:** ``` profit = potential_payout - stake platform_fee = profit × 0.01 net_payout = potential_payout - platform_fee ``` **Revenue Withdrawn (Verified):** - **4,037 SBETS** (2 withdrawals: 2,026 + 2,011) - **0.35 SUI** (1 withdrawal) --- ### **Smart Contract Functions** **User Functions:** - `place_bet` - Place SUI bet - `place_bet_sbets` - Place SBETS bet **Settlement (OracleCap or AdminCap):** - `settle_bet` / `settle_bet_admin` - Settle SUI bet - `settle_bet_sbets` / `settle_bet_sbets_admin` - Settle SBETS bet - `void_bet` / `void_bet_admin` - Void SUI bet - `void_bet_sbets` / `void_bet_sbets_admin` - Void SBETS bet **Admin Only (requires AdminCap):** - `withdraw_fees` / `withdraw_fees_sbets` - Extract revenue - `deposit_liquidity` / `deposit_liquidity_sbets` - Add to treasury - `mint_oracle_cap` / `revoke_oracle_cap` - Manage oracles - `set_pause` - Pause/unpause platform - `update_fee` - Change fee percentage - `update_limits` - Change min/max bet - `emergency_withdraw` / `emergency_withdraw_sbets` - Emergency (paused only) --- ### **Key Files** | File | Purpose | |------|---------| | `sources/betting.move` | Smart contract source | | `client/src/hooks/useOnChainBet.ts` | Frontend bet placement | | `server/services/settlementWorker.ts` | Auto-settlement service | | `server/services/blockchainBetService.ts` | On-chain settlement execution | | `server/routes-simple.ts` | Bet validation & 80-min cutoff | --- ### **Environment Variables** ``` BETTING_PACKAGE_ID=0xfaf371c3c9fe2544cc1ce9a40b07621503b300bf3a65b8fab0dba134636e8b32 BETTING_PLATFORM_ID=0xae1b0dfed589c6ce5b7dafdb7477954670f0f73530668b5476e3a429b64099b3 ADMIN_CAP_ID=0xaec276da96bc9fb7781213f3aedb18eacf30af1932dc577abbe5529583251827 ADMIN_PRIVATE_KEY=<stored as Railway secret> VITE_BETTING_PACKAGE_ID=0xfaf371c3c9fe2544cc1ce9a40b07621503b300bf3a65b8fab0dba134636e8b32 VITE_BETTING_PLATFORM_ID=0xae1b0dfed589c6ce5b7dafdb7477954670f0f73530668b5476e3a429b64099b3 ``` --- **Status: PRODUCTION READY** - On-chain auto-payout verified, fee collection working, treasury safety guaranteed.
Betting Flow (100% On-Chain)
User Places Bet → Calls place_bet (SUI) or place_bet_sbets (SBETS)

Tokens go directly to smart contract treasury
Liability tracked: total_potential_liability += potential_payout
Bet object created with betObjectId stored in PostgreSQL
Settlement Worker (runs every 60s)

Checks for settled events from API-Sports
Calls settle_bet_admin or settle_bet_sbets_admin on-chain
If Bet WON:

net_payout = potential_payout - (profit × 1%)
Payout sent from treasury to user wallet
Fee added to accrued_fees
Liability reduced
If Bet LOST:

Full stake added to accrued_fees
Liability reduced
No payout
Admin Withdraws Revenue → withdraw_fees / withdraw_fees_sbets

Security Model
Capability-Based Access Control (OTW Pattern):

AdminCap: Single capability minted at deployment, required for all admin operations
OracleCap: Can be minted by admin for settlement oracles
Private key stored as Railway secret (ADMIN_PRIVATE_KEY)
80-Minute Betting Cutoff (Server-Authoritative):

Event NOT found in cache → REJECT
Cache age > 2 minutes → REJECT
Live match minute >= 80 → REJECT
Event already started (upcoming cache) → REJECT
Client flags (isLive, matchMinute) are IGNORED - server determines status
Rejection Codes:
EVENT_NOT_FOUND, STALE_EVENT_DATA, STALE_MATCH_DATA, UNVERIFIABLE_MATCH_TIME, MATCH_TIME_EXCEEDED, EVENT_STATUS_UNCERTAIN, EVENT_VERIFICATION_ERRORSafety Guarantees:

Smart contract REJECTS bets if treasury can't cover potential payout
assert!(treasury >= net_payout) enforced on-chain
Liability always reduced on settlement (won/lost/voided)
add to white paper


2 messages & 13 actions
Now let me update the hero section to reflect the accurate 1% fee on profit:
Checkpoint made
Add detailed betting flow, security, and treasury safety information
Worked for 1 minute
check the 3 pending bets ? is it caus matches hasnt finished ? and if its finished should be settleed


2 messages & 14 actions
Found 3 pending bets. Let me check if these matches have finished:
you said both and the third ?


1 message & 1 action
You're right, let me clarify: **3 bets on 2 matches:** | Bet ID | Match | Stake | Status | |--------|-------|-------|--------| | 18 | Al-Sailiya vs Al-Rayyan SC | 1000 SBETS | 2nd Half | | 17 | Al-Sailiya vs Al-Rayyan SC | 0.4 SUI | 2nd Half | | 16 | Hapoel Ironi Karmiel vs Ironi Nesher | 0.3 SUI | 2nd Half | - **Bets 17 & 18** are on the **same match** (Al-Sailiya vs Al-Rayyan SC) - currently 1-3 - **Bet 16** is on a **different match** (Hapoel Ironi Karmiel vs Ironi Nesher) - currently 2-0 Both matches are still playing (2nd half). Once they finish with status "FT", the settlement worker will process all 3 bets.
send command to force push to git


1 message & 1 action
I can't run force push commands - destructive git operations are blocked for safety. Run this yourself in the Shell tab: ```bash git push --force origin main ```
why the bets that was same one stay pending oher succeded ? check if payout happended onchain from treasury


9 messages & 36 actions
I see on-chain events! Let me check the specific bets:
Checkpoint made
Fix issue where multiple bets on the same match were not being settled
Worked for 4 minutes
send command to force push to git


1 message & 1 action
I can't run force push - it's blocked for safety. Run this yourself in the Shell tab: ```bash git push --force origin main ```
why no matches in live and upcoming ? dissapeared all


Show less
Checked console and system logs
The API is returning 0 events for all sports. Let me check if you've hit the API rate limit:

You've hit your API-Sports daily limit. The API returned:

"You have reached the request limit for the day"

Earlier logs showed 72,687/75,000 requests used. With all the event fetching and odds prefetching, you hit the cap.

Options:

Wait - The limit resets daily (midnight UTC or your subscription timezone)
Upgrade plan - Go to https://dashboard.api-football.com to increase your limit
The platform will automatically start showing events again once the quota resets.

Worked for 58 seconds
Earlier logs showed 72,687/75,000 requests used. With all the event fetching and odds prefetching, you hit the cap. - must reduce thats alot and have ultra plan , reduce with not harming nothing at all


Optimizing API-Sports request usage
I'll optimize the API usage now. Key changes:

Odds prefetcher: 60s → 5 minutes, 250 → 100 fixtures
Settlement worker: 30s → 2 minutes, skip when no pending bets
Better caching for events
Good, I've updated two key settings. Now let me also update the log message to reflect the new 2 minute interval. And I should reduce the batch size for odds prefetching from 250 to 100 fixtures.

Now let me reduce the batch size for odds prefetching and update the log message:

Good, I've made the main optimizations. Now let me also add a skip when no unsettled bets are pending in the settlement worker to avoid unnecessary API calls. Let me check the settlement worker checkAndSettleBets function.

Now let me add early exit when no pending bets to avoid unnecessary API calls:

Now let me reduce settlement worker to only check sports with API endpoints (4 instead of 7):